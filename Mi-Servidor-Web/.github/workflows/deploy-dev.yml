name: Despliegue Desarrollo (Windows)

on:
  push:
    branches: [ "develop" ]

jobs:
  deploy-dev:
    runs-on: self-hosted
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Desplegar Dev con Volúmenes
      shell: powershell
      run: |
        echo "Desplegando entorno de desarrollo..."
        
        # 1. Copiar archivos a una ruta fija y estable (ej: C:\temp\dev)
        # Esto evita problemas de bloqueos de archivos en la carpeta del runner
        $DevPath = "C:\docker-dev-temp"
        
        # Crear directorios si no existen
        if (!(Test-Path -Path "$DevPath\nginx")) { New-Item -ItemType Directory -Force -Path "$DevPath\nginx" }
        if (!(Test-Path -Path "$DevPath\html")) { New-Item -ItemType Directory -Force -Path "$DevPath\html" }
        
        # Copiar archivos (Force para sobreescribir)
        Copy-Item -Path ".\nginx\default.conf" -Destination "$DevPath\nginx\" -Force
        Copy-Item -Path ".\html\*" -Destination "$DevPath\html\" -Recurse -Force
        
        # 2. Lógica del contenedor
        if (!(docker ps -q -f name=web-dev)) {
            # SI NO EXISTE: Lo creamos
            # Fíjate en la sintaxis -v: RutaWindows:RutaContenedor
            
            # Limpieza previa por si acaso
            if (docker ps -a -q -f name=web-dev) { docker rm web-dev }
            
            docker run -d `
              --name web-dev `
              -p 8081:80 `
              -v ${DevPath}\html:/usr/share/nginx/html `
              -v ${DevPath}\nginx\default.conf:/etc/nginx/conf.d/default.conf `
              nginx:alpine
        } else {
            # SI YA EXISTE: Recargamos Nginx
            echo "Recargando configuración..."
            docker exec web-dev nginx -s reload
        }